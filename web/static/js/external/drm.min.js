!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).flowplayer=e.flowplayer||{},e.flowplayer.drm=t())}(this,(function(){"use strict";const e="com.widevine.alpha",t="com.apple.fps.1_0";var n=Object.freeze({__proto__:null,WIDEVINE:e,PLAYREADY:"com.microsoft.playready",CLEARKEY:"org.w3.clearkey",FAIRPLAY:t,LICENSE_SERVER:"license_server",KEY:"key",KEY_ID:"kid",HTTP_HEADERS:"http_headers",QUERY_PARAMS:"query_params",CERTIFICATE:"certificate",VENDOR:"vendor",REQUEST_MEDIA_KEY_SYSTEM_ACCESS_FUNCTION:"request_media_key_system_access_function"});function r(t){const n={};return Object.keys(t).forEach((function(r){var s;s=r,[e].filter((function(e){return e===s})).length&&function(t,n,r){if(t===e){Object.assign(r,n),r.widevineLicenseUrl=n.license_server,r.emeEnabled=!0;const e=n.http_headers;n.request_media_key_system_access_function&&(r.requestMediaKeySystemAccessFunc=n.request_media_key_system_access_function||null),e&&(r.licenseXhrSetup=function(t){Object.keys(e).forEach((function(n){t.setRequestHeader(n,e[n])}))})}}(r,t[r],n)})),n}const s=[e,"com.microsoft.playready","org.w3.clearkey"];function a(e){const t={};return Object.keys(e).forEach((function(n){var r;r=n,s.find((function(e){return e===r}))&&(t[n]=function(e){return Object.assign({serverURL:e.license_server,httpRequestHeaders:e.http_headers},e)}(e[n]))})),t}const o=(e,t)=>fetch(e,t).then(i).then(e=>new Uint8Array(e)),i=e=>{if(e.ok)return e.arrayBuffer();throw c(e)},c=e=>new Error(`http:error status=${e.status} during key retrieval`);var f=Object.freeze({__proto__:null,fairplay_fetch_certificate:(e,t)=>{o(e).then(t)},fairplay_request_license:function(e,t,n){o(e+new URLSearchParams(t.queryParams).toString(),{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:t.message}).then(n)}});var u=Object.freeze({__proto__:null,fairplay_fetch_certificate:(e,t)=>{o(e).then(t)},fairplay_request_license:function(e,t,n){const r=new FormData;var s;r.set("assetid",t.assetId),r.set("spc",(s=t.message,btoa(Array.prototype.map.call(s,(function(e){return String.fromCharCode(e)})).join("")))),fetch(e,{method:"POST",body:r,headers:t.headers}).then(e=>{if(e.ok)return e.text();throw c(e)}).then(e=>function(e){const t=atob(e),n=new Uint8Array(t.length);return Array.prototype.forEach.call(t,(function(e,t){n[t]=e.charCodeAt(0)})),n}(e)).then(n)}}),d=Object.freeze({__proto__:null,ezdrm:f,buydrm:u});function y(e,n,r){const s=n[t],a=s.certificate;if(!s||!a)return;if(e.src&&0===e.src.indexOf("blob:"))return;const o=s.vendor||"ezdrm",i="string"==typeof o?d[o]:o;i.fairplay_fetch_certificate(a,(function(a){e.webkitSetMediaKeys(new window.WebKitMediaKeys(t));const o=r.initData,c=function(e){const t=function(e){const t=new Uint16Array(e);return String.fromCharCode(...t)}(e.buffer);return t.substring(t.indexOf("skd:")+6).split(";").pop()}(o);if(!c)return console.debug("flowplayer::drm::fairplay - unable to extract content id from init data");const f=function(e,t,n){"string"==typeof t&&(t=function(e){const t=new ArrayBuffer(2*e.length),n=new Uint16Array(t);return Array(...Array(e.length)).map((e,t)=>t).forEach(t=>{n[t]=e.charCodeAt(t)}),n}(t));let r=0;const s=new ArrayBuffer(e.byteLength+4+t.byteLength+4+n.byteLength),a=new DataView(s);new Uint8Array(s,r,e.byteLength).set(e),r+=e.byteLength,a.setUint32(r,t.byteLength,!0),r+=4;const o=new Uint16Array(s,r,t.length);o.set(t),r+=o.byteLength,a.setUint32(r,n.byteLength,!0),r+=4;return new Uint8Array(s,r,n.byteLength).set(n),new Uint8Array(s,0,s.byteLength)}(o,c,a),u=e.webkitKeys.createSession("application/x-mpegurl",f);u.addEventListener("webkitkeyerror",console.debug.bind(console,"webkitkeyerror")),u.addEventListener("webkitkeymessage",(function(e){const r={message:e.message,assetId:c,headers:s.http_headers||{},queryParams:n[t].query_params||{}};i.fairplay_request_license(s.license_server,r,e=>u.update(e))}))}))}class DRM{init(e,t,n){n.on("src",(function(t){var s;if(!(null===(s=t.data)||void 0===s?void 0:s.drm))return;const o=e.hls||{},i=t.data.drm?r(t.data.drm):{};n.setOpts({hls:Object.assign(o,i)}),n.on("webkitneedkey",y.bind(null,n,t.data.drm||{}));const c=e.dash||{},f=t.data.drm?a(t.data.drm):{};n.setOpts({dash:Object.assign(c,{drm:f})})}))}}return Object.assign(DRM,n),function(e,t){if("object"==typeof exports&&"undefined"!=typeof module)return t;if(null===document.currentScript)return t;"flowplayer"in e||(e.flowplayer={extensions:[]});const n=e.flowplayer;"function"==typeof n?n(t):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(t)||n.extensions.push(t))}(window,DRM),DRM}));
