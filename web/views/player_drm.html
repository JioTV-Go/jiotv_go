<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JioTV Go</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: black;
        overflow-y: hidden;
      }
      
      /* Unmute button styling */
      .unmute-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(234, 67, 53, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .unmute-overlay:hover {
        background: rgba(234, 67, 53, 1);
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
      }
      
      .unmute-overlay svg {
        width: 32px;
        height: 32px;
        fill: currentColor;
      }
      
      .unmute-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }
      
      /* Increase Shaka Player control icons size */
      .shaka-video-container .material-icons-round {
        font-size: 28px !important;
      }
    </style>
    <script src="/static/external/shaka-player.ui.js"></script>
    <!-- Shaka Player UI compiled library default CSS: -->
    <link rel="stylesheet" href="/static/external/shaka-player-controls.css" />
  </head>

  <body>
    <div data-shaka-player-container>
      <!-- The data-shaka-player tag will make the UI library use this video element.
            If no video is provided, the UI will automatically make one inside the container div. -->
      <video
        autoplay
        data-shaka-player
        id="jiotv_go_player"
        style="width: 100%; height: 100%"
      ></video>
      
      <!-- Unmute button overlay -->
      <button id="unmute-btn" class="unmute-overlay" title="Click to unmute">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
      </button>
    </div>
    <script>
      document.addEventListener("shaka-ui-loaded", async () => {
        const video = document.getElementById("jiotv_go_player");
        const ui = video["ui"];
        const config = {
          seekBarColors: {
            base: "rgba(234, 67, 53, 0.5)",
            buffered: "rgba(234, 67, 53, 0.7)",
            played: "rgb(234, 67, 53)",
          },
          volumeBarColors: {
            base: "rgba(234, 67, 53, 0.5)",
            level: "rgb(234, 67, 53)",
          },
        };
        ui.configure(config);

        const controls = ui.getControls();
        const player = controls.getPlayer();

        player.configure({
          drm: {
            servers: {
              "com.widevine.alpha": "{{ .license_url }}",
            },
            advanced: {
              "com.widevine.alpha": {
                videoRobustness: "SW_SECURE_CRYPTO",
                audioRobustness: "SW_SECURE_CRYPTO",
              },
            },
          },
          streaming: {
            retryParameters: {
              maxAttempts: 3,
            },
            bufferingGoal: 5, // 5 seconds
          },
        });

        const RequestType = shaka.net.NetworkingEngine.RequestType;

        player
          .getNetworkingEngine()
          .registerRequestFilter(function (type, request, context) {
            // Only add headers to license requests:
            if (
              type == shaka.net.NetworkingEngine.RequestType.SEGMENT &&
              request.uris[0].includes("/render.dash")
            ) {
              const newUrl = new URL(request.uris[0]);
              // add query params host and path
              const channelHost = "{{ .channel_host }}";
              const channelPath = "{{ .channel_path }}";
              if (channelHost !== "" && channelPath !== "") {
                newUrl.searchParams.append("host", channelHost);
                newUrl.searchParams.append("path", channelPath);
              }
              request.uris = [newUrl.toString()];
            }
          });

        try {
          await player.load("{{ .play_url }}");
          console.log("The video has now been loaded!");
          
          // Smart autoplay: try unmuted first, fall back to muted if needed
          await trySmartAutoplay(video);
        } catch (e) {
          console.error("Error loading video", e);
          switch (e.code) {
            case 1001:
              alert("The channel is not available.");
              break;
            case 6001:
              alert(
                "Widevine DRM content can't be played in http (except localhost). Please enable https in server."
              );
              break;
            default:
              alert(
                "An error occurred. Please try again later. Shaka Error code: " +
                  e.code
              );
          }
        }

        // Smart autoplay function
        async function trySmartAutoplay(video) {
          try {
            // First try to play unmuted
            video.muted = false;
            await video.play();
            console.log("Unmuted autoplay successful");
            // Hide unmute button since audio is already enabled
            updateUnmuteButton();
          } catch (e) {
            console.log("Unmuted autoplay blocked, falling back to muted autoplay:", e.message);
            // Fall back to muted autoplay
            video.muted = true;
            try {
              await video.play();
              console.log("Muted autoplay successful");
              // Show unmute button for muted playback
              updateUnmuteButton();
            } catch (e2) {
              console.error("Both unmuted and muted autoplay failed:", e2.message);
              // Show unmute button anyway in case user interaction can start playback
              updateUnmuteButton();
            }
          }
        }

        // Unmute button functionality
        const unmuteBtn = document.getElementById("unmute-btn");
        
        const updateUnmuteButton = () => {
          if (video.muted) {
            unmuteBtn.classList.remove("hidden");
          } else {
            unmuteBtn.classList.add("hidden");
          }
        };
        
        unmuteBtn.addEventListener("click", () => {
          video.muted = false;
          video.volume = 0.8; // Set to 80% volume
          updateUnmuteButton();
        });
        
        // Listen for mute state changes (e.g., via Shaka UI controls)
        video.addEventListener("volumechange", updateUnmuteButton);
        
        // Initial state
        updateUnmuteButton();

        // Rotate to landscape on fullscreen enter
        video.addEventListener("fullscreenchange", () => {
          if (document.fullscreenElement) {
            if (screen.orientation) {
              screen.orientation.lock("landscape").catch((e) => {
                if (e.name !== "NotSupportedError") {
                  console.error(e);
                }
              });
            }
          } else {
            if (screen.orientation) {
              screen.orientation.unlock();
            }
          }
        });
      });
    </script>
  </body>
</html>
